<!DOCTYPE html>
<html>
<head>
  <title>Formatear XML de Enunciados</title>
</head>
<body>
  <h1>Procesador de XML de Preguntas</h1>
  <input type="file" id="xmlInput" accept=".xml">
  <button id="procesarBtn">Procesar XML</button>
  <br><br>
  <textarea id="salidaXml" rows="20" cols="100"></textarea>

  <script>
    document.getElementById("procesarBtn").onclick = async () => {
      const input = document.getElementById("xmlInput");
      if (!input.files.length) return alert("Selecciona un archivo XML primero");

      const text = await input.files[0].text();
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(text, "application/xml");

      const preguntas = xmlDoc.getElementsByTagName("pregunta");

      for (let pregunta of preguntas) {
        const enunciado = pregunta.getElementsByTagName("enunciado")[0];
        if (enunciado) {
          const raw = enunciado.textContent.trim();
          const partes = separarTextoYCodigo(raw);
          const html = partes.map(p =>
            p.tipo === "codigo"
              ? `<pre><code class="language-java">${escapeHtml(p.texto)}</code></pre>`
              : `<p>${escapeHtml(p.texto)}</p>`
          ).join("\n");

          // Reemplazar contenido original con CDATA HTML
          while (enunciado.firstChild) enunciado.removeChild(enunciado.firstChild);
          const cdata = xmlDoc.createCDATASection(html);
          enunciado.appendChild(cdata);
        }
      }

      const serializer = new XMLSerializer();
      const nuevoXml = serializer.serializeToString(xmlDoc);
      document.getElementById("salidaXml").value = nuevoXml;
    };

    function separarTextoYCodigo(texto) {
      const lineas = texto.split("\n");
      const bloques = [];
      let actual = [];
      let tipoActual = null;

      for (let linea of lineas) {
        const esCodigo = /^\s{2,}|\t/.test(linea) || /^[{};]/.test(linea.trim());
        const tipo = esCodigo ? "codigo" : "texto";

        if (tipo !== tipoActual && actual.length > 0) {
          bloques.push({ tipo: tipoActual, texto: actual.join("\n") });
          actual = [];
        }

        actual.push(linea);
        tipoActual = tipo;
      }

      if (actual.length > 0) {
        bloques.push({ tipo: tipoActual, texto: actual.join("\n") });
      }

      return bloques;
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }
    // Descargar autom√°ticamente el nuevo XML como archivo
    const blob = new Blob([nuevoXml], { type: "application/xml" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "preguntas_formateadas.xml";
    link.click();

  </script>
</body>
</html>

